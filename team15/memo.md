流入元分析　フロー

| ステップ       | 処理内容                                                    | 主な関数／構文                                                         | 目的・ポイント                                                                       |
| :--------- | :------------------------------------------------------ | :-------------------------------------------------------------- | :---------------------------------------------------------------------------- |
| **Step 0** | **日本語フォント設定（文字化け防止）**                                   | `!apt-get install fonts-ipafont-*`<br>`matplotlib.font_manager` | Colabなどではデフォルトで日本語フォントが入っていないため、グラフやラベルが「□□□」にならないようにフォントを導入・設定する。            |
| **Step 1** | **環境セットアップ（基本ライブラリ）**                                   | `pip install pandas numpy`<br>`import pandas as pd`             | 分析に必要なライブラリをインストールし、pandas・numpyを使えるようにする。`np.random.seed(42)`で乱数を固定（再現性の確保）。 |
| **Step 2** | **GA4風セッションデータを作成**                                     | `pd.DataFrame({...})`                                           | 実際のGA4（Google Analytics 4）から出力されるようなセッションデータを擬似的に作成。<br>各列は以下のような意味：          |
|            | 列名                                                      | 内容                                                              |                                                                               |
|            | `session_id`                                            | セッションの一意ID                                                      |                                                                               |
|            | `user_pseudo_id`                                        | 匿名化されたユーザーID                                                    |                                                                               |
|            | `source_medium`                                         | 流入経路（例：Google検索、広告、メール、比較サイトなど）                                 |                                                                               |
|            | `device_category`                                       | デバイス種別（PC・スマホ）                                                  |                                                                               |
|            | `pageviews`, `events`                                   | 閲覧ページ数・イベント数（行動量）                                               |                                                                               |
|            | `engaged`                                               | サイトに一定時間滞在したか（エンゲージメント指標）                                       |                                                                               |
|            | `landing`, `last_page`                                  | 最初と最後に見たページ                                                     |                                                                               |
|            | `search_term`, `page_title`                             | 内部検索語やページタイトル（後でテキスト分析に利用）                                      |                                                                               |
|            | → 最後に `sessions.to_csv()` でCSV出力。これが「ga4_sessions.csv」。 |                                                                 |                                                                               |
| **Step 3** | **CRMデータ作成（成約／失注フラグ付け）**                                | `groupby`, `merge`, `np.random.rand`                            | 顧客ごとの「失注確率」を推定し、「成約 or 失注」を疑似的に決める処理。以下のサブ工程：                                 |
|            | ① ユニーク顧客抽出                                              | `.drop_duplicates()`                                            | セッション単位からユーザー単位に変換。                                                           |
|            | ② 行動傾向集計                                                | `.groupby("user_pseudo_id").agg({...})`                         | 各ユーザーの「比較サイト経由率」「解約系検索率」を算出。                                                  |
|            | ③ 失注確率計算                                                | `prob = base_p + 0.5*...`                                       | 「基本30％＋比較サイト＋ネガ検索」に応じて失注リスクを加算。                                               |
|            | ④ 範囲調整                                                  | `.clip(0,0.95)`                                                 | 失注確率が100％を超えないよう制限。                                                           |
|            | ⑤ 結合                                                    | `.merge()`                                                      | `user_pseudo_id`をキーに確率をCRMデータへ結合。                                             |
|            | ⑥ 乱数で失注判定                                               | `np.random.rand(len(crm)) < lost_prob`                          | 各人の確率に基づいて「失注(1)／成約(0)」をランダム決定（サイコロを振るイメージ）。                                  |
|            | ⑦ 保存・集計                                                 | `.to_csv()` と `.mean()`                                         | 「crm_data.csv」を出力し、全体の失注率を確認。                                                 |
| **Step 4** | **失注率分析と可視化**                                           | `groupby`, `plot(kind="bar")`                                   | 行動ログ＋CRMを結合し、以下の角度で失注率を分析：                                                    |
|            | ① 流入チャネル別                                               | `data.groupby("source_medium")["lost_flag"].mean()`             | どの流入経路のユーザーが離脱しやすいか。                                                          |
|            | ② ページ別                                                  | `groupby("page_title")`                                         | どのページ閲覧者に失注が多いか。                                                              |
|            | ③ 検索語別                                                  | `groupby("search_term")`                                        | どんな検索語のユーザーが離脱しやすいか。                                                          |
|            | ④ グラフ化                                                  | `matplotlib` + 日本語フォント設定                                        | 棒グラフで失注率を可視化。タイトルや軸ラベルも日本語で表示。                                                |



トピック別　フロー

| 処理ステップ                | コード部分                                                           | 内容（やっていること）                         | ポイント・目的                                |
| :-------------------- | :-------------------------------------------------------------- | :---------------------------------- | :------------------------------------- |
| **① ライブラリ導入**         | `!pip install scikit-learn`                                     | 機械学習用ライブラリ scikit-learn をインストール     | TF-IDF・NMFを使うために必要                     |
| **② データ結合**           | `data = sessions.merge(crm, on="user_pseudo_id", how="left")`   | GA4セッション（行動データ）とCRM（成約／失注）を統合       | 行動と結果をセットにすることで「どんな話題の人が失注しやすいか」を分析できる |
| **③ テキスト作成**          | `data["text"] = data["page_title"] + " " + data["search_term"]` | ページタイトル＋検索語を1つの文章にまとめる              | 顧客が見たページ内容＋検索語から興味・関心テーマを抽出する準備        |
| **④ TF-IDF変換**        | `TfidfVectorizer(max_features=2000, ngram_range=(1,2))`         | 単語の重要度を数値化（TF-IDF）                  | よく出るけど他では珍しい単語ほど重要と判断される               |
| **⑤ NMFでトピック抽出**      | `NMF(n_components=6)`                                           | テキストを6種類のトピックに分解                    | 各トピック＝似た内容（例：解約系・料金系・申込系）をまとめた“テーマ”    |
| **⑥ 代表単語抽出**          | `terms = np.array(tfidf.get_feature_names_out())`               | 各トピックを特徴づける単語を抽出（上位6語など）            | トピックの内容を人間が理解できるように“ラベル”をつける           |
| **⑦ 各セッションの所属トピック判定** | `data["main_topic"] = topic_strength.idxmax(axis=1)`            | その人（またはセッション）がどのトピックに一番強く反応しているかを決定 | 「この人はトピック3（料金系）に属する」と分類される             |
| **⑧ トピック別失注率算出**      | `groupby("main_topic")["lost_flag"].mean()`                     | 各トピックの中で失注（lost_flag=1）の割合を計算       | ＝「その話題に関心がある人のうち、何％が失注したか」             |
| **⑨ 結果表示**            | `print(f"{topic_name}: 失注率={loss_rate:.2f}  代表語: ...")`         | 失注率が高いトピック順に出力                      | 例：「キャンペーン詳細・違約金」系が失注率50％ → 不安要素あり      |
| **⑩ グラフ可視化**          | `topic_loss_rate.plot(kind="bar")`                              | トピックごとの失注率を棒グラフ化                    | どの話題の人が離脱しやすいかを直感的に把握できる               |
